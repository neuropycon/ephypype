<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>03. Compute inverse solution &#8212; ephypype 0.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          Ephypype</a>
        <span class="navbar-text navbar-version pull-left"><b>0.2</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../auto_examples/index.html">Gallery</a></li>
                <li><a href="../../api.html">API</a></li>
                <li><a href="../../tutorials/index.html">Tutorials</a></li>
                <li><a href="../index.html">Workshop</a></li>
                <li><a href="https://github.com/neuropycon/ephypype">Github</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">03. Compute inverse solution</a><ul>
<li><a class="reference internal" href="#import-modules">Import modules</a></li>
<li><a class="reference internal" href="#define-data-and-variables">Define data and variables</a></li>
<li><a class="reference internal" href="#define-functions">Define functions</a></li>
<li><a class="reference internal" href="#specify-nodes">Specify Nodes</a><ul>
<li><a class="reference internal" href="#infosource-and-datasource">Infosource and Datasource</a></li>
<li><a class="reference internal" href="#event-node">Event Node</a></li>
<li><a class="reference internal" href="#inverse-solution-node">Inverse solution Node</a></li>
<li><a class="reference internal" href="#morphing-node">Morphing Node</a></li>
</ul>
</li>
<li><a class="reference internal" href="#create-workflow">Create workflow</a></li>
<li><a class="reference internal" href="#connect-nodes">Connect Nodes</a></li>
<li><a class="reference internal" href="#run-workflow">Run workflow</a><ul>
<li><a class="reference internal" href="#workflow-graph">Workflow graph</a></li>
</ul>
</li>
<li><a class="reference internal" href="#results">Results</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../../_sources/auto_workshop/01_meg/plot_02_events_inverse_stc.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-workshop-01-meg-plot-02-events-inverse-stc-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="compute-inverse-solution">
<span id="plot-events-inverse"></span><span id="sphx-glr-auto-workshop-01-meg-plot-02-events-inverse-stc-py"></span><h1>03. Compute inverse solution<a class="headerlink" href="#compute-inverse-solution" title="Permalink to this heading">¶</a></h1>
<p>This workflow mainly calls the
<a class="reference internal" href="../../auto_examples/plot_inverse.html#source-reconstruction"><span class="std std-ref">inverse solution pipeline</span></a>
performing source reconstruction starting from the cleaned raw data obtained
by <a class="reference internal" href="plot_01_meg_preprocessing.html#preproc-meg"><span class="std std-ref">02. Preprocess MEG data</span></a>.</p>
<p>The first node of the workflow (<a class="reference internal" href="#concat-event"><span class="std std-ref">Event Node</span></a>) <strong>extracts the events</strong> from
stimulus channel <code class="docutils literal notranslate"><span class="pre">STI101</span></code>. The events are saved in the <a class="reference internal" href="#concat-event"><span class="std std-ref">Event Node</span></a>
directory. For each subject, the different runs are also concatenated in
one single raw file and saved in <a class="reference internal" href="#concat-event"><span class="std std-ref">Event Node</span></a> directory.
The input of this node are the different runs taken from the
preprocessing workflow directory, i.e. the cleaned
raw data created by <a class="reference internal" href="plot_01_meg_preprocessing.html#preproc-meg"><span class="std std-ref">02. Preprocess MEG data</span></a>.</p>
<p>In the <a class="reference internal" href="#inv-solution-node"><span class="std std-ref">Inverse solution Node</span></a> the raw <strong>data are epoched</strong> accordingly to
events specified in <code class="docutils literal notranslate"><span class="pre">json</span></code> file and created in <a class="reference internal" href="#concat-event"><span class="std std-ref">Event Node</span></a>.
The evoked datasets are created by averaging the different conditions specified
in the <code class="docutils literal notranslate"><span class="pre">json</span></code> file. The estimated neural time series are reconstructed
by the evoked data for each condition by <strong>dSPM</strong> inverse method.</p>
<p>Finally the source estimates obtained by the
<a class="reference internal" href="#inv-solution-node"><span class="std std-ref">Inverse solution Node</span></a> are morphed to the <code class="docutils literal notranslate"><span class="pre">fsaverage</span></code> brain in the
<a class="reference internal" href="#morphing-node"><span class="std std-ref">Morphing Node</span></a>.</p>
<p>An overview of the workflow, its nodes and connections is given by the <a class="reference internal" href="#graph-inverse"><span class="std std-ref">Workflow graph</span></a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Before running this pipeline, the coregistration between the MRI
and MEG device needs to be performed. It is reccomened to look at the MNE
<a href="https://mne.tools/stable/auto_tutorials/forward/20_source_alignment.html#sphx-glr-auto-tutorials-forward-20-source-alignment-py " target="_blank">tutorial</a></p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Authors: Annalisa Pascarella &lt;a.pascarella@iac.cnr.it&gt;</span>
<span class="c1"># License: BSD (3-clause)</span>

<span class="c1"># sphinx_gallery_thumbnail_number = 1</span>
</pre></div>
</div>
<section id="import-modules">
<h2>Import modules<a class="headerlink" href="#import-modules" title="Permalink to this heading">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pprint</span>  <span class="c1"># noqa</span>

<span class="kn">import</span> <span class="nn">nipype.pipeline.engine</span> <span class="k">as</span> <span class="nn">pe</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.utility</span> <span class="kn">import</span> <span class="n">Function</span>

<span class="kn">from</span> <span class="nn">ephypype.nodes</span> <span class="kn">import</span> <span class="n">create_iterator</span><span class="p">,</span> <span class="n">create_datagrabber</span>
<span class="kn">from</span> <span class="nn">ephypype.pipelines.fif_to_inv_sol</span> <span class="kn">import</span> <span class="n">create_pipeline_source_reconstruction</span>  <span class="c1"># noqa</span>
</pre></div>
</div>
</section>
<section id="define-data-and-variables">
<h2>Define data and variables<a class="headerlink" href="#define-data-and-variables" title="Permalink to this heading">¶</a></h2>
<p>Let us specify the variables that are specific for the data analysis (the
main directories where the data are stored, the list of subjects and
sessions, …) and the variable specific for the <strong>inverse pipeline</strong>
(events_id, inverse method, …) in a <a class="reference download external" download="" href="https://github.com/neuropycon/ephypype/tree/master/doc/workshop/01_meg/params.json"><code class="xref download docutils literal notranslate"><span class="pre">json</span></code></a> file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;params.json&quot;</span><span class="p">))</span>

<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">({</span><span class="s1">&#39;parameters&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">]})</span>
<span class="n">data_type</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;data_type&quot;</span><span class="p">]</span>
<span class="n">subject_ids</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;subject_ids&quot;</span><span class="p">]</span>
<span class="n">NJOBS</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;NJOBS&quot;</span><span class="p">]</span>
<span class="n">session_ids</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;session_ids&quot;</span><span class="p">]</span>
<span class="n">conditions</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;conditions&quot;</span><span class="p">]</span>
<span class="n">subjects_dir</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;subjects_dir&quot;</span><span class="p">]</span>

<span class="n">is_short</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;short&quot;</span><span class="p">]</span>  <span class="c1"># to analyze a segment of data</span>

<span class="k">if</span> <span class="s2">&quot;data_path&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">data_path</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;data_path&quot;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">data_path</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data_path : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">data_path</span><span class="p">)</span>

<span class="c1"># source reconstruction</span>
<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">({</span><span class="s1">&#39;inverse parameters&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;inverse&quot;</span><span class="p">]})</span>
<span class="n">events_id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;inverse&quot;</span><span class="p">][</span><span class="s1">&#39;events_id&#39;</span><span class="p">]</span>
<span class="n">condition</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;inverse&quot;</span><span class="p">][</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span>
<span class="n">t_min</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;inverse&quot;</span><span class="p">][</span><span class="s1">&#39;tmin&#39;</span><span class="p">]</span>
<span class="n">t_max</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;inverse&quot;</span><span class="p">][</span><span class="s1">&#39;tmax&#39;</span><span class="p">]</span>
<span class="n">spacing</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;inverse&quot;</span><span class="p">][</span><span class="s1">&#39;spacing&#39;</span><span class="p">]</span>  <span class="c1"># oct-6</span>
<span class="n">snr</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;inverse&quot;</span><span class="p">][</span><span class="s1">&#39;snr&#39;</span><span class="p">]</span>
<span class="n">inv_method</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;inverse&quot;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>  <span class="c1"># dSPM</span>
<span class="n">parc</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;inverse&quot;</span><span class="p">][</span><span class="s1">&#39;parcellation&#39;</span><span class="p">]</span>  <span class="c1"># aparc</span>

<span class="n">trans_fname</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;inverse&quot;</span><span class="p">][</span><span class="s1">&#39;trans_fname&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>{&#39;parameters&#39;: {&#39;NJOBS&#39;: 1,
                &#39;conditions&#39;: [&#39;famous&#39;, &#39;scrambled&#39;, &#39;unfamiliar&#39;],
                &#39;data_path&#39;: &#39;/home/pasca/Science/workshop/PracticalMEEG/ds000117/derivatives/meg_derivatives&#39;,
                &#39;data_type&#39;: &#39;fif&#39;,
                &#39;session_ids&#39;: [&#39;01&#39;, &#39;02&#39;],
                &#39;short&#39;: False,
                &#39;subject_ids&#39;: [&#39;sub-01&#39;],
                &#39;subjects_dir&#39;: &#39;/home/pasca/Science/workshop/PracticalMEEG/ds000117/FSF&#39;}}
data_path : /home/pasca/Science/workshop/PracticalMEEG/ds000117/derivatives/meg_derivatives
{&#39;inverse parameters&#39;: {&#39;condition&#39;: [&#39;face/famous&#39;,
                                      &#39;scrambled&#39;,
                                      &#39;face/unfamiliar&#39;],
                        &#39;events_id&#39;: {&#39;face/famous/first&#39;: 5,
                                      &#39;face/famous/immediate&#39;: 6,
                                      &#39;face/famous/long&#39;: 7,
                                      &#39;face/unfamiliar/first&#39;: 13,
                                      &#39;face/unfamiliar/immediate&#39;: 14,
                                      &#39;face/unfamiliar/long&#39;: 15,
                                      &#39;scrambled/first&#39;: 17,
                                      &#39;scrambled/immediate&#39;: 18,
                                      &#39;scrambled/long&#39;: 19},
                        &#39;method&#39;: &#39;dSPM&#39;,
                        &#39;parcellation&#39;: &#39;aparc&#39;,
                        &#39;snr&#39;: 3.0,
                        &#39;spacing&#39;: &#39;oct-6&#39;,
                        &#39;tmax&#39;: 1.0,
                        &#39;tmin&#39;: -0.2,
                        &#39;trans_fname&#39;: &#39;*-trans.fif&#39;}}
</pre></div>
</div>
</section>
<section id="define-functions">
<h2>Define functions<a class="headerlink" href="#define-functions" title="Permalink to this heading">¶</a></h2>
<p>Here we define two different functions that will be encapsulated in two
different nodes (<a class="reference internal" href="#concat-event"><span class="std std-ref">Event Node</span></a> and <a class="reference internal" href="#morphing-node"><span class="std std-ref">Morphing Node</span></a>).
The <code class="docutils literal notranslate"><span class="pre">run_events_concatenate</span></code> function extracts events from the stimulus
channel while <code class="docutils literal notranslate"><span class="pre">compute_morph_stc</span></code> morph the source estimates obtained by
the <a class="reference internal" href="#inv-solution-node"><span class="std std-ref">Inverse solution Node</span></a> into the <code class="docutils literal notranslate"><span class="pre">fsaverage</span></code> brain.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_events_concatenate</span><span class="p">(</span><span class="n">list_ica_files</span><span class="p">,</span> <span class="n">subject</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The events are extracted from stim channel &#39;STI101&#39;. The events are saved</span>
<span class="sd">    to the Node directory.</span>
<span class="sd">    For each subject, the different runs are concatenated in one single raw</span>
<span class="sd">    file and saved in the Node directory. We take the different runs from the</span>
<span class="sd">    preprocessing workflow directory, i.e. the cleaned raw data.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">list_ica_files</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">mne</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="mi">4096</span> <span class="o">+</span> <span class="mi">256</span>  <span class="c1"># mask for excluding high order bits</span>
    <span class="n">delay_item</span> <span class="o">=</span> <span class="mf">0.0345</span>
    <span class="n">min_duration</span> <span class="o">=</span> <span class="mf">0.015</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;processing subject: </span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">raw_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">events_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">fname_events_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Loading raw data&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">run_fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_ica_files</span><span class="p">):</span>
        <span class="n">run</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">raw</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_raw_fif</span><span class="p">(</span><span class="n">run_fname</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">find_events</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">stim_channel</span><span class="o">=</span><span class="s1">&#39;STI101&#39;</span><span class="p">,</span>
                                 <span class="n">consecutive</span><span class="o">=</span><span class="s1">&#39;increasing&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                                 <span class="n">mask_type</span><span class="o">=</span><span class="s1">&#39;not_and&#39;</span><span class="p">,</span>
                                 <span class="n">min_duration</span><span class="o">=</span><span class="n">min_duration</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  S </span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">run</span><span class="si">}</span><span class="s2"> %s&quot;</span><span class="p">)</span>

        <span class="n">fname_events</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;run_</span><span class="si">{</span><span class="n">run</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">-eve.fif&#39;</span><span class="p">)</span>
        <span class="n">mne</span><span class="o">.</span><span class="n">write_events</span><span class="p">(</span><span class="n">fname_events</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span>
        <span class="n">fname_events_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname_events</span><span class="p">)</span>

        <span class="n">delay</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">delay_item</span> <span class="o">*</span> <span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;sfreq&#39;</span><span class="p">]))</span>
        <span class="n">events</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">events</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">delay</span>
        <span class="n">events_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>

        <span class="n">raw_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

    <span class="n">raw</span><span class="p">,</span> <span class="n">events</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">concatenate_raws</span><span class="p">(</span><span class="n">raw_list</span><span class="p">,</span> <span class="n">events_list</span><span class="o">=</span><span class="n">events_list</span><span class="p">)</span>
    <span class="n">raw</span><span class="o">.</span><span class="n">set_eeg_reference</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">raw_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s1">_sss_filt_dsamp_ica-raw.fif&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">raw_file</span><span class="p">)</span>

    <span class="n">raw</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">raw_file</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">event_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s1">_sss_filt_dsamp_ica-raw-eve.fif&#39;</span><span class="p">)</span>
    <span class="n">mne</span><span class="o">.</span><span class="n">write_events</span><span class="p">(</span><span class="n">event_file</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">raw_list</span>
    <span class="k">del</span> <span class="n">raw</span>

    <span class="k">return</span> <span class="n">raw_file</span><span class="p">,</span> <span class="n">event_file</span><span class="p">,</span> <span class="n">fname_events_files</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_morph_stc</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">cond_files</span><span class="p">,</span> <span class="n">subjects_dir</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>
    <span class="kn">import</span> <span class="nn">mne</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;processing subject: </span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Morph STCs</span>
    <span class="n">stc_morphed_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">cond_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cond_files</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">conditions</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cond_file</span><span class="p">)</span>
        <span class="n">stc</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_source_estimate</span><span class="p">(</span><span class="n">cond_file</span><span class="p">)</span>

        <span class="n">morph</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">compute_source_morph</span><span class="p">(</span>
            <span class="n">stc</span><span class="p">,</span> <span class="n">subject_from</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">subject_to</span><span class="o">=</span><span class="s1">&#39;fsaverage&#39;</span><span class="p">,</span>
            <span class="n">subjects_dir</span><span class="o">=</span><span class="n">subjects_dir</span><span class="p">)</span>
        <span class="n">stc_morphed</span> <span class="o">=</span> <span class="n">morph</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">stc</span><span class="p">)</span>
        <span class="n">stc_morphed_file</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;mne_dSPM_inverse_morph-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">conditions</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>  <span class="c1"># noqa</span>
        <span class="n">stc_morphed</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">stc_morphed_file</span><span class="p">)</span>

        <span class="n">stc_morphed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stc_morphed_file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stc_morphed_files</span>


<span class="k">def</span> <span class="nf">show_files</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">files</span>
</pre></div>
</div>
</section>
<section id="specify-nodes">
<h2>Specify Nodes<a class="headerlink" href="#specify-nodes" title="Permalink to this heading">¶</a></h2>
<section id="infosource-and-datasource">
<h3>Infosource and Datasource<a class="headerlink" href="#infosource-and-datasource" title="Permalink to this heading">¶</a></h3>
<p>We create an <code class="docutils literal notranslate"><span class="pre">infosurce</span></code> node to pass input filenames to the <code class="docutils literal notranslate"><span class="pre">datasource</span></code>
node to grab the data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">infosource</span> <span class="o">=</span> <span class="n">create_iterator</span><span class="p">([</span><span class="s1">&#39;subject_id&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">subject_ids</span><span class="p">])</span>
</pre></div>
</div>
<p>We set the dir from which to get the preprocessed MEG data</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">preproc_wf_name</span> <span class="o">=</span> <span class="s1">&#39;preprocessing_dsamp_short_workflow&#39;</span> <span class="k">if</span> <span class="n">is_short</span> \
    <span class="k">else</span> <span class="s1">&#39;preprocessing_dsamp_workflow&#39;</span>
<span class="n">ica_dir</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">preproc_wf_name</span><span class="p">,</span> <span class="s1">&#39;preproc_meg_dsamp_pipeline&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we want to grab both the raw MEG data and the coregistration file,
thus we have to specify the search patterns for <code class="docutils literal notranslate"><span class="pre">raw_file</span></code> and
<code class="docutils literal notranslate"><span class="pre">trans_file</span></code> which are parameterized with the values defined in
<code class="docutils literal notranslate"><span class="pre">template_args</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">template_path</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>

<span class="n">raw_file</span> <span class="o">=</span> <span class="s1">&#39;_session_id_*_subject_id_</span><span class="si">%s</span><span class="s1">/ica/</span><span class="si">%s</span><span class="s1">*ses*_*filt*ica.fif&#39;</span>
<span class="n">trans_file</span> <span class="o">=</span> <span class="s1">&#39;../../</span><span class="si">%s</span><span class="s1">/ses-meg/meg_short/</span><span class="si">%s%s</span><span class="s1">.fif&#39;</span> <span class="k">if</span> <span class="n">is_short</span> <span class="k">else</span> \
    <span class="s1">&#39;../../</span><span class="si">%s</span><span class="s1">/ses-meg/meg/</span><span class="si">%s%s</span><span class="s1">.fif&#39;</span>
<span class="n">field_template</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">raw_file</span><span class="o">=</span><span class="n">raw_file</span><span class="p">,</span> <span class="n">trans_file</span><span class="o">=</span><span class="n">trans_file</span><span class="p">)</span>

<span class="n">template_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">raw_file</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">]],</span>
    <span class="n">trans_file</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s2">&quot;-trans&quot;</span><span class="p">]])</span>

<span class="n">datasource</span> <span class="o">=</span> <span class="n">create_datagrabber</span><span class="p">(</span><span class="n">ica_dir</span><span class="p">,</span> <span class="n">template_path</span><span class="p">,</span> <span class="n">template_args</span><span class="p">,</span>
                                <span class="n">field_template</span><span class="o">=</span><span class="n">field_template</span><span class="p">,</span>
                                <span class="n">infields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">],</span>
                                <span class="n">outfields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;raw_file&#39;</span><span class="p">,</span> <span class="s1">&#39;trans_file&#39;</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="event-node">
<span id="concat-event"></span><h3>Event Node<a class="headerlink" href="#event-node" title="Permalink to this heading">¶</a></h3>
<p>We define the Node that encapsulates <code class="docutils literal notranslate"><span class="pre">run_events_concatenate</span></code> function
(see <a class="reference internal" href="#graph-inverse"><span class="std std-ref">Workflow graph</span></a>) and specify the inputs and outputs of the function</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">concat_event</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;list_ica_files&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">],</span>
             <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;raw_file&#39;</span><span class="p">,</span> <span class="s1">&#39;event_file&#39;</span><span class="p">,</span> <span class="s1">&#39;fname_events_files&#39;</span><span class="p">],</span>
             <span class="n">function</span><span class="o">=</span><span class="n">run_events_concatenate</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;concat_event&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="inverse-solution-node">
<span id="inv-solution-node"></span><h3>Inverse solution Node<a class="headerlink" href="#inverse-solution-node" title="Permalink to this heading">¶</a></h3>
<p>Ephypype creates for us a pipeline to compute inverse solution which can be
connected to the other nodes we created.
The inverse solution pipeline is implemented by the function
<a class="reference internal" href="../../generated/ephypype.pipelines.create_pipeline_source_reconstruction.html#ephypype.pipelines.create_pipeline_source_reconstruction" title="ephypype.pipelines.create_pipeline_source_reconstruction"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_pipeline_source_reconstruction()</span></code></a>,
thus to instantiate this pipeline node, we pass our parameters to it.
Since we want to do source estimation in three different conditions
(famous faces, unfamiliar faces and scrambled), we provide all information
related to the events in the <code class="docutils literal notranslate"><span class="pre">json</span></code> file where we also specify as inverse
method dSPM.</p>
<p>The inverse pipeline contains three nodes that wrap the MNE Python functions
that perform the source reconstruction steps. In particular, the three nodes
are:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../generated/ephypype.interfaces.mne.LFComputation.html#ephypype.interfaces.mne.LFComputation" title="ephypype.interfaces.mne.LF_computation.LFComputation"><code class="xref py py-func docutils literal notranslate"><span class="pre">LFComputation()</span></code></a> compute the
Lead Field matrix</p></li>
<li><p><a class="reference internal" href="../../generated/ephypype.interfaces.mne.NoiseCovariance.html#ephypype.interfaces.mne.NoiseCovariance" title="ephypype.interfaces.mne.Inverse_solution.NoiseCovariance"><code class="xref py py-func docutils literal notranslate"><span class="pre">NoiseCovariance()</span></code></a> computes
the noise covariance matrix</p></li>
<li><p><a class="reference internal" href="../../generated/ephypype.interfaces.mne.InverseSolution.html#ephypype.interfaces.mne.InverseSolution" title="ephypype.interfaces.mne.Inverse_solution.InverseSolution"><code class="xref py py-func docutils literal notranslate"><span class="pre">InverseSolution()</span></code></a> estimates
the time series of the neural sources on a set of dipoles grid</p></li>
</ul>
<p>The <strong>input node</strong> (<code class="docutils literal notranslate"><span class="pre">raw</span></code>, <code class="docutils literal notranslate"><span class="pre">sbj_id</span></code>, <code class="docutils literal notranslate"><span class="pre">trans_file</span></code> and <code class="docutils literal notranslate"><span class="pre">events_file</span></code>)
will be specified once the different nodes are connected.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">inv_sol_workflow</span> <span class="o">=</span> <span class="n">create_pipeline_source_reconstruction</span><span class="p">(</span>
    <span class="n">data_path</span><span class="p">,</span> <span class="n">subjects_dir</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span> <span class="n">inv_method</span><span class="o">=</span><span class="n">inv_method</span><span class="p">,</span>
    <span class="n">is_epoched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_evoked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">events_id</span><span class="o">=</span><span class="n">events_id</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="n">condition</span><span class="p">,</span>
    <span class="n">t_min</span><span class="o">=</span><span class="n">t_min</span><span class="p">,</span> <span class="n">t_max</span><span class="o">=</span><span class="n">t_max</span><span class="p">,</span> <span class="n">all_src_space</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parc</span><span class="o">=</span><span class="n">parc</span><span class="p">,</span> <span class="n">snr</span><span class="o">=</span><span class="n">snr</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>******************** {}
</pre></div>
</div>
</section>
<section id="morphing-node">
<span id="id1"></span><h3>Morphing Node<a class="headerlink" href="#morphing-node" title="Permalink to this heading">¶</a></h3>
<p>The last Node we define encapsulates <code class="docutils literal notranslate"><span class="pre">compute_morph_stc</span></code> function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">morph_stc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
    <span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;conditions&#39;</span><span class="p">,</span> <span class="s1">&#39;cond_files&#39;</span><span class="p">,</span> <span class="s1">&#39;subjects_dir&#39;</span><span class="p">],</span>  <span class="c1"># noqa</span>
             <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;stc_morphed_files&#39;</span><span class="p">],</span>
             <span class="n">function</span><span class="o">=</span><span class="n">compute_morph_stc</span><span class="p">),</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;morph_stc&quot;</span><span class="p">)</span>

<span class="n">morph_stc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="n">conditions</span>
<span class="n">morph_stc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">subjects_dir</span> <span class="o">=</span> <span class="n">subjects_dir</span>
</pre></div>
</div>
</section>
</section>
<section id="create-workflow">
<h2>Create workflow<a class="headerlink" href="#create-workflow" title="Permalink to this heading">¶</a></h2>
<p>Then, we can create our workflow and specify the <code class="docutils literal notranslate"><span class="pre">base_dir</span></code> which tells
nipype the directory in which to store the outputs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">src_estimation_wf_name</span> <span class="o">=</span> <span class="s1">&#39;source_dsamp_short_reconstruction_&#39;</span> <span class="k">if</span> <span class="n">is_short</span> \
    <span class="k">else</span> <span class="s1">&#39;source_dsamp_full_reconstruction_&#39;</span>

<span class="n">src_reconstruction_pipeline_name</span> <span class="o">=</span> <span class="n">src_estimation_wf_name</span> <span class="o">+</span> \
    <span class="n">inv_method</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">parc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="n">main_workflow</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">src_reconstruction_pipeline_name</span><span class="p">)</span>
<span class="n">main_workflow</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">data_path</span>
</pre></div>
</div>
</section>
<section id="connect-nodes">
<h2>Connect Nodes<a class="headerlink" href="#connect-nodes" title="Permalink to this heading">¶</a></h2>
<p>Finally, we connect the nodes two at a time. First, we connect the
output (<code class="docutils literal notranslate"><span class="pre">subject_id</span></code>) of the <code class="docutils literal notranslate"><span class="pre">infosource</span></code> node to the input of
<code class="docutils literal notranslate"><span class="pre">datasource</span></code> node. So, these two nodes taken together can grab data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">main_workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,</span>  <span class="s1">&#39;subject_id&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>First, we connect their outputs to the input of
(<code class="docutils literal notranslate"><span class="pre">list_ica_files</span></code>, <code class="docutils literal notranslate"><span class="pre">subject</span></code>) of <a class="reference internal" href="#concat-event"><span class="std std-ref">Event Node</span></a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">main_workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;raw_file&#39;</span><span class="p">,</span> <span class="n">show_files</span><span class="p">),</span>
                      <span class="n">concat_event</span><span class="p">,</span> <span class="s1">&#39;list_ica_files&#39;</span><span class="p">)</span>
<span class="n">main_workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">concat_event</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The output of <code class="docutils literal notranslate"><span class="pre">infosource</span></code>, <code class="docutils literal notranslate"><span class="pre">datasource</span></code> and <code class="docutils literal notranslate"><span class="pre">concat_event</span></code> are the
inputs of <code class="docutils literal notranslate"><span class="pre">inv_sol_workflow</span></code>, thus we connect these nodes two at time.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">main_workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">show_files</span><span class="p">),</span>
                      <span class="n">inv_sol_workflow</span><span class="p">,</span> <span class="s1">&#39;inputnode.sbj_id&#39;</span><span class="p">)</span>
<span class="n">main_workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="s1">&#39;trans_file&#39;</span><span class="p">,</span>
                      <span class="n">inv_sol_workflow</span><span class="p">,</span> <span class="s1">&#39;inputnode.trans_file&#39;</span><span class="p">)</span>
<span class="n">main_workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">concat_event</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;raw_file&#39;</span><span class="p">,</span> <span class="n">show_files</span><span class="p">),</span>
                      <span class="n">inv_sol_workflow</span><span class="p">,</span> <span class="s1">&#39;inputnode.raw&#39;</span><span class="p">)</span>
<span class="n">main_workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">concat_event</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;event_file&#39;</span><span class="p">,</span> <span class="n">show_files</span><span class="p">),</span>
                      <span class="n">inv_sol_workflow</span><span class="p">,</span> <span class="s1">&#39;inputnode.events_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we connect <code class="docutils literal notranslate"><span class="pre">infosource</span></code> and <code class="docutils literal notranslate"><span class="pre">inv_sol_workflow</span></code> to
<code class="docutils literal notranslate"><span class="pre">morph_stc</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">main_workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">morph_stc</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">)</span>
<span class="n">main_workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inv_sol_workflow</span><span class="p">,</span> <span class="s1">&#39;inv_solution.stc_files&#39;</span><span class="p">,</span>
                      <span class="n">morph_stc</span><span class="p">,</span> <span class="s1">&#39;cond_files&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="run-workflow">
<h2>Run workflow<a class="headerlink" href="#run-workflow" title="Permalink to this heading">¶</a></h2>
<p>Now, we are now ready to execute our workflow.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">main_workflow</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph2use</span><span class="o">=</span><span class="s1">&#39;colored&#39;</span><span class="p">)</span>  <span class="c1"># colored</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&#39;/home/pasca/Science/workshop/PracticalMEEG/ds000117/derivatives/meg_derivatives/source_dsamp_full_reconstruction_dSPM_aparc/graph.png&#39;
</pre></div>
</div>
<section id="workflow-graph">
<span id="graph-inverse"></span><h3>Workflow graph<a class="headerlink" href="#workflow-graph" title="Permalink to this heading">¶</a></h3>
<p>Take a moment to pause and notice how the connections
here correspond to how we connected the nodes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>  <span class="c1"># noqa</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">data_path</span><span class="p">,</span> <span class="n">src_reconstruction_pipeline_name</span><span class="p">,</span> <span class="s1">&#39;graph.png&#39;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">main_workflow</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;execution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;remove_unnecessary_outputs&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span><span class="p">}</span>
<span class="n">main_workflow</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">plugin</span><span class="o">=</span><span class="s1">&#39;LegacyMultiProc&#39;</span><span class="p">,</span> <span class="n">plugin_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;n_procs&#39;</span><span class="p">:</span> <span class="n">NJOBS</span><span class="p">})</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_02_events_inverse_stc_001.png" srcset="../../_images/sphx_glr_plot_02_events_inverse_stc_001.png" alt="plot 02 events inverse stc" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>sub-01
sub-01
[&#39;/home/pasca/Science/workshop/PracticalMEEG/ds000117/derivatives/meg_derivatives/preprocessing_dsamp_workflow/preproc_meg_dsamp_pipeline/_session_id_01_subject_id_sub-01/ica/sub-01_ses-meg_task-facerecognition_run-01_proc-sss_meg_filt_dsamp_ica.fif&#39;, &#39;/home/pasca/Science/workshop/PracticalMEEG/ds000117/derivatives/meg_derivatives/preprocessing_dsamp_workflow/preproc_meg_dsamp_pipeline/_session_id_02_subject_id_sub-01/ica/sub-01_ses-meg_task-facerecognition_run-02_proc-sss_meg_filt_dsamp_ica.fif&#39;]
/home/pasca/Science/workshop/PracticalMEEG/ds000117/derivatives/meg_derivatives/source_dsamp_full_reconstruction_dSPM_aparc/_subject_id_sub-01/concat_event/sub-01_sss_filt_dsamp_ica-raw.fif
/home/pasca/Science/workshop/PracticalMEEG/ds000117/derivatives/meg_derivatives/source_dsamp_full_reconstruction_dSPM_aparc/_subject_id_sub-01/concat_event/sub-01_sss_filt_dsamp_ica-raw.fif
/home/pasca/Science/workshop/PracticalMEEG/ds000117/derivatives/meg_derivatives/source_dsamp_full_reconstruction_dSPM_aparc/_subject_id_sub-01/concat_event/sub-01_sss_filt_dsamp_ica-raw-eve.fif

&lt;networkx.classes.digraph.DiGraph object at 0x7f2aaaefc520&gt;
</pre></div>
</div>
</section>
</section>
<section id="results">
<h2>Results<a class="headerlink" href="#results" title="Permalink to this heading">¶</a></h2>
<p>The output of this workflow is the reconstructed neural time series morphed to the standard
FreeSurfer average subject named fsaverage.The output is stored in the
workflow dir defined by <code class="docutils literal notranslate"><span class="pre">base_dir</span></code>. To plot the estimated source timeseries
we can use <a class="reference internal" href="plot_03_stc.html#plot-stc"><span class="std std-ref">04. Plot contrast</span></a>.</p>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  15.672 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-workshop-01-meg-plot-02-events-inverse-stc-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/a90d0e6d92c70245550c9bd43834da3f/plot_02_events_inverse_stc.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_02_events_inverse_stc.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/583b26cf078c7d349cb88e17e48de9f2/plot_02_events_inverse_stc.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_02_events_inverse_stc.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2022, Neuropycon Developers. Last updated on 2022-12-11.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>